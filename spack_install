#!/usr/bin/env bash
#
# spack_install  — build a package with the *site* Spack while
#                   writing everything into your own $HOME.
#
# Usage:  spack_install PACKAGE [INSTALL_PATH]
#         default INSTALL_PATH = $HOME/spack_installs
#
set -euo pipefail

# ------------------------- parse arguments --------------------------
pkg=${1:-}
if [[ -z ${pkg} ]]; then
  cat <<EOF
Usage: spack_install PACKAGE [INSTALL_PATH]

If INSTALL_PATH is omitted, packages are installed under:
  \$HOME/spack_installs

Verify that PACKAGE exists with:
  spack list PACKAGE
EOF
  exit 1
fi

install_path=${2:-"$HOME/spack_installs"}   # user‑writable store
modules_root="${install_path}/modules"      # private module tree

# ------------------ one‑shot, user‑scope Spack tweaks ---------------
# 1. keep Spack's solver/bootstrap stuff in \$HOME
export SPACK_USER_BOOTSTRAP_ROOT="$HOME/.spack/bootstrap"

# 2. private install tree
spack config add config:install_tree:"$install_path"

# 3. reuse the cluster’s pre‑built packages
spack config add upstreams:system:install_tree:/opt/ohpc/pub/spack/opt/spack

# 4. write TCL modulefiles into \$HOME instead of /opt
spack config add modules:default:roots:tcl:"$modules_root"

# (Optional) pull in already‑loaded system modules as externals
# spack external find  --scope=user   # uncomment if/when you need it

# ---------------------------- build --------------------------------
spack install "$pkg"
